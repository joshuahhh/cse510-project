<!DOCTYPE html>

<head>
  <style>
    #game-board {
      display: grid;
      grid-template-columns: 100px 100px 100px 100px 100px;
      grid-template-rows: 100px 100px 100px 100px 100px;
      justify-content: center;
      padding: 20px;
    }
    #game-board div {
      background: #d9d9d9;
      border: 2px solid black;
      width: 100px;
      height: 100px;
    }
    #game-board div.user-next {
      background: blue;
    }
    #game-board div.correct-next {
      background: green;
    }
    #game-board img {
      height: 100px;
      width: 100px;
      cursor: grab;
      position: absolute; /* layer images */
      object-fit: scale-down; /* fit in cell */
    }
    textarea {
      font-family: monospace !important;
    }
  </style>
</head>

<body>
  <div id="game-board">
  </div>
  <script type="module">
    import { liveDebugger} from './library.js'

    var size = 5


    // *************************
    // Setting up the game board
    // *************************

    var gameBoard = document.getElementById('game-board');
    for (var y = 0; y < size; y++) {
      for (var x = 0; x < size; x++) {
        var cell = document.createElement('div');
        cell.dataset.x = x;
        cell.dataset.y = y;
        gameBoard.appendChild(cell);
      }
    }

    var hero = document.createElement('img');
    hero.src = "images/mario.png";
    gameBoard.querySelector('div[data-x="3"][data-y="2"').appendChild(hero);

    var enemy = document.createElement('img');
    enemy.src = "images/bowser.png";
    gameBoard.querySelector('div[data-x="4"][data-y="4"').appendChild(enemy);



    // ********
    // Dragging
    // ********

    let draggedElem = null;

    // Start drag
    hero.addEventListener("mousedown", function (event) {
      draggedElem = hero;
      event.preventDefault();
    });
    enemy.addEventListener("mousedown", function (event) {
      draggedElem = enemy;
      event.preventDefault();
    });

    // Drag into cell
    Array.from(gameBoard.children).forEach((el) => {
      el.addEventListener("mouseenter", function (event) {
        if (draggedElem) {
          el.appendChild(draggedElem);

          calculateEnemyMove();
        }
      });
    });

    // End drag
    document.addEventListener("mouseup", function () {
      draggedElem = null;
    });



    // ***********************
    // Updating the enemy move
    // ***********************

    function calculateEnemyMove() {
      // Clear existing blue square
      var oldNext = gameBoard.querySelector("div.user-next");
      if (oldNext) {
        oldNext.classList.remove("user-next");
      }

      // Get player positions
      var heroX = +hero.parentElement.dataset.x
      var heroY = +hero.parentElement.dataset.y
      var enemyX = +enemy.parentElement.dataset.x
      var enemyY = +enemy.parentElement.dataset.y

      // Calculate enemy direction

      // Option 1: Hard-coded
      var enemyDirection = 'left';

      // Option 2: Using live tool
      var enemyDirection = liveDebugger({
        input: {
          heroX: heroX,
          heroY: heroY,
          enemyX: enemyX,
          enemyY: enemyY,
        },
        showTool: true
      });

      // Set up new blue square
      var nextX = enemyX, nextY = enemyY;
      if (enemyDirection === 'left') {
        nextX--;
      } else if (enemyDirection === 'right') {
        nextX++;
      } else if (enemyDirection === 'up') {
        nextY--;
      } else if (enemyDirection === 'down') {
        nextY++;
      }
      gameBoard.querySelector('div[data-x="' + nextX + '"][data-y="' + nextY + '"]').classList.add("user-next");
    }

    // And run it to start
    calculateEnemyMove();

  </script>
</body>